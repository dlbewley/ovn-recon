name: Cleanup Old Pre-releases

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight
  workflow_dispatch: # Enable manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Purge pre-releases after full release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PURGE_AFTER_DAYS: 7
        run: |
          echo "Fetching releases..."
          # Fetch the last 100 releases
          releases=$(gh release list -R ${{ github.repository }} --limit 100 --json tagName,isPrerelease,publishedAt)

          # Identify stable releases and their publication dates
          stable_releases=$(echo "$releases" | jq -r '.[] | select(.isPrerelease == false) | "\(.tagName) \(.publishedAt)"')

          echo "Checking pre-releases..."
          echo "$releases" | jq -c '.[] | select(.isPrerelease == true)' | while read -r pre; do
            tag=$(echo "$pre" | jq -r .tagName)

            # Strip pre-release suffix (e.g., v0.1.0-rc1 -> v0.1.0)
            # This logic assumes semver-like tags (vX.Y.Z-suffix)
            base_tag=$(echo "$tag" | sed -E 's/-.*//')

            # Check if a corresponding stable release exists
            stable_info=$(echo "$stable_releases" | grep "^$base_tag ")
            if [ -n "$stable_info" ]; then
              published_at=$(echo "$stable_info" | awk '{print $2}')
              published_ts=$(date -d "$published_at" +%s)
              now_ts=$(date +%s)
              age_days=$(( (now_ts - published_ts) / 86400 ))

              if [ "$age_days" -ge "$PURGE_AFTER_DAYS" ]; then
                echo "Purging pre-release $tag: base release $base_tag was published $age_days days ago."
                gh release delete "$tag" --yes --cleanup-tag -R ${{ github.repository }}
              else
                echo "Keeping pre-release $tag: base release $base_tag is only $age_days days old."
              fi
            else
              echo "Keeping pre-release $tag: No stable release for $base_tag found yet."
            fi
          done
